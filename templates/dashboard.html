<!DOCTYPE html>
<html>
  <head>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link
      rel="stylesheet"
      as="style"
      onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&amp;family=Lexend%3Awght%40400%3B500%3B700%3B900&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900"
    />

    <title>Dashboard - Manahstiti</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@15.0.0"></script>
  </head>
  <body>
    <div class="relative flex size-full min-h-screen flex-col bg-[#f9fbf9] group/design-root overflow-x-hidden" style='font-family: Lexend, "Noto Sans", sans-serif;'>
      <div class="layout-container flex h-full grow flex-col">
        <!-- Header -->
        <header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-b-[#e9f1e9] px-10 py-3">
                  <a href="/" class="flex items-center gap-4 text-[#101910] hover:opacity-80 transition-opacity">
          <div class="size-8">
            <img src="/static/images/LOGO.png" alt="Manahstiti Logo" class="w-full h-full object-contain">
          </div>
          <h2 class="text-[#101910] text-lg font-bold leading-tight tracking-[-0.015em]">Manahstiti</h2>
        </a>
          <div class="flex flex-1 justify-end gap-8">
            <div class="flex items-center gap-9">
              <a class="text-[#101910] text-sm font-medium leading-normal hover:text-[#1E5245] transition-colors" href="/">Home</a>
              <a class="text-[#101910] text-sm font-medium leading-normal hover:text-[#1E5245] transition-colors text-[#1E5245] font-semibold" href="/dashboard">Dashboard</a>
              <a class="text-[#101910] text-sm font-medium leading-normal hover:text-[#1E5245] transition-colors" href="/resources">Resources</a>
              <a class="text-[#101910] text-sm font-medium leading-normal hover:text-[#1E5245] transition-colors" href="/about">About</a>
            </div>
            
            <div class="flex items-center gap-3">
              <!-- New Assessment Button -->
              <button
                onclick="window.location.href='/assessment'"
                class="flex items-center gap-2 px-4 py-2 bg-[#1E5245] text-white text-sm font-medium rounded-lg hover:bg-[#2a6b56] transition-colors duration-200"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                <span>New Assessment</span>
              </button>
              
              <!-- User Profile Dropdown -->
              <div class="relative">
                <button
                  id="profileDropdownBtn"
                  onclick="toggleProfileDropdown()"
                  class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-[#f8fcf8] transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-[#1E5245] focus:ring-offset-2"
                >
                  <!-- User Avatar -->
                  <div class="w-8 h-8 bg-gradient-to-br from-[#1E5245] to-[#2a6b56] rounded-full flex items-center justify-center text-white text-sm font-semibold">
                    <span id="userInitials">U</span>
                  </div>
                  <!-- User Name -->
                  <span id="userName" class="text-[#101910] text-sm font-medium hidden sm:block">Loading...</span>
                  <!-- Dropdown Arrow -->
                  <svg id="dropdownArrow" class="w-4 h-4 text-[#578e57] transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </button>
                
                <!-- Dropdown Menu -->
                <div
                  id="profileDropdown"
                  class="absolute right-0 mt-2 w-56 bg-white rounded-xl shadow-lg border border-[#e9f1e9] py-2 z-50 hidden"
                >
                  <!-- User Info Section -->
                  <div class="px-4 py-3 border-b border-[#e9f1e9]">
                    <div class="flex items-center gap-3">
                      <div class="w-10 h-10 bg-gradient-to-br from-[#1E5245] to-[#2a6b56] rounded-full flex items-center justify-center text-white font-semibold">
                        <span id="dropdownUserInitials">U</span>
                      </div>
                      <div>
                        <p id="dropdownUserName" class="text-[#101910] font-medium text-sm">Loading...</p>
                        <p id="dropdownUserEmail" class="text-[#578e57] text-xs">Loading...</p>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Menu Items -->
                  <div class="py-1">
                    <a href="/assessment" class="flex items-center gap-3 px-4 py-2 text-[#101910] hover:bg-[#f8fcf8] transition-colors">
                      <svg class="w-4 h-4 text-[#578e57]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                      </svg>
                      <span class="text-sm">Take Assessment</span>
                    </a>
                    
                    <a href="/profile" class="w-full flex items-center gap-3 px-4 py-2 text-[#101910] hover:bg-[#f8fcf8] transition-colors">
                      <svg class="w-4 h-4 text-[#578e57]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                              </svg>
                        <span class="text-sm">Edit Profile</span>
                      </a>
                    
                    <a href="/chat" class="flex items-center gap-3 px-4 py-2 text-[#101910] hover:bg-[#f8fcf8] transition-colors">
                      <svg class="w-4 h-4 text-[#578e57]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                      </svg>
                      <span class="text-sm">AI Friend</span>
                    </a>
                    
                    <a href="/resources" class="flex items-center gap-3 px-4 py-2 text-[#101910] hover:bg-[#f8fcf8] transition-colors">
                      <svg class="w-4 h-4 text-[#578e57]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                      </svg>
                      <span class="text-sm">Resources</span>
                    </a>
                  </div>
                  
                  <!-- Divider -->
                  <div class="border-t border-[#e9f1e9] my-1"></div>
                  
                  <!-- Logout -->
                  <button onclick="logout()" class="w-full flex items-center gap-3 px-4 py-2 text-red-600 hover:bg-red-50 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                    </svg>
                    <span class="text-sm font-medium">Logout</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </header>

        <!-- Main Content -->
        <div class="px-40 flex flex-1 justify-center py-5">
          <div class="layout-content-container flex flex-col max-w-[960px] flex-1">
            <!-- Welcome Section -->
            <div class="flex flex-col gap-3 p-4">
              <h1 class="text-[#101910] text-[32px] font-bold leading-tight">Your Mental Health Dashboard</h1>
              <p class="text-[#578e57] text-base font-normal leading-normal">Track your mental health journey and view your assessment history</p>
            </div>

            <!-- Loading State -->
            <div id="loading" class="flex justify-center items-center py-20">
              <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[#1E5245]"></div>
            </div>

            <!-- Dashboard Content -->
            <div id="dashboard-content" class="hidden">
              <!-- Quick Stats -->
              <div class="grid grid-cols-1 md:grid-cols-3 gap-6 p-4">
                <div class="bg-white rounded-xl p-6 border border-[#e9f1e9] shadow-sm">
                  <h3 class="text-[#101910] text-lg font-bold mb-2">Total Assessments</h3>
                  <p id="total-assessments" class="text-[#1E5245] text-3xl font-bold">0</p>
                </div>
                <div class="bg-white rounded-xl p-6 border border-[#e9f1e9] shadow-sm">
                  <h3 class="text-[#101910] text-lg font-bold mb-2">Latest Score</h3>
                  <p id="latest-score" class="text-[#1E5245] text-3xl font-bold">-</p>
                  <p id="latest-classification" class="text-[#578e57] text-sm mt-1">-</p>
                </div>
                <div class="bg-white rounded-xl p-6 border border-[#e9f1e9] shadow-sm">
                  <h3 class="text-[#101910] text-lg font-bold mb-2">Progress Trend</h3>
                  <p id="progress-trend" class="text-[#1E5245] text-3xl font-bold">-</p>
                  <p class="text-[#578e57] text-sm mt-1">vs. previous assessment</p>
                </div>
              </div>

              <!-- Assessment History -->
              <div class="p-4">
                <h2 class="text-[#101910] text-[24px] font-bold leading-tight mb-4">Assessment History</h2>
                
                <!-- No assessments message -->
                <div id="no-assessments" class="bg-white rounded-xl p-8 border border-[#e9f1e9] text-center hidden">
                  <div class="mb-4">
                    <svg class="mx-auto h-16 w-16 text-[#bdeebd]" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zm0 4a1 1 0 011-1h6a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h6a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                    </svg>
                  </div>
                  <h3 class="text-[#101910] text-lg font-bold mb-2">No Assessments Yet</h3>
                  <p class="text-[#578e57] text-sm mb-4">Take your first mental health assessment to start tracking your wellness journey.</p>
                  <button
                    onclick="window.location.href='/assessment'"
                    class="bg-[#1E5245] text-white py-2 px-6 rounded-lg font-medium hover:bg-[#2a6b56] transition-colors duration-200"
                  >
                    Take First Assessment
                  </button>
                </div>

                <!-- Assessment list -->
                <div id="assessment-list" class="space-y-4">
                  <!-- Assessment items will be populated here -->
                </div>
              </div>
            </div>

            <!-- Error State -->
            <div id="error-state" class="hidden p-4">
              <div class="bg-red-50 border border-red-200 rounded-xl p-6 text-center">
                <h3 class="text-red-800 text-lg font-bold mb-2">Error Loading Dashboard</h3>
                <p class="text-red-600 text-sm mb-4">We couldn't load your dashboard data. Please try refreshing the page.</p>
                <button
                  onclick="window.location.reload()"
                  class="bg-red-600 text-white py-2 px-6 rounded-lg font-medium hover:bg-red-700 transition-colors duration-200"
                >
                  Refresh Page
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Appwrite Configuration
      const client = new Appwrite.Client();
      client
        .setEndpoint('https://fra.cloud.appwrite.io/v1') // Your Frankfurt endpoint
        .setProject('manahstiti-mental-health-lays'); // Your project ID

      const account = new Appwrite.Account(client);
      const databases = new Appwrite.Databases(client);

      // Database Configuration
      const DATABASE_ID = '6834e4790036ae46ecce';
      const ASSESSMENTS_COLLECTION_ID = '6834e4a100351df915b4';

      let currentUser = null;
      let assessments = [];

      // Authentication check
      async function checkAuthentication() {
        try {
          currentUser = await account.get();
          console.log('User authenticated:', currentUser);
          
          // Update profile information
          updateProfileInfo(currentUser);
          
          // Load dashboard data
          await loadDashboardData();
        } catch (error) {
          console.error('User not authenticated:', error);
          // Redirect to login page
          window.location.href = '/login';
        }
      }

      // Update profile information in the UI
      function updateProfileInfo(user) {
        const name = user.name || 'User';
        const email = user.email || '';
        
        // Get initials from name
        const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        
        // Update header profile
        document.getElementById('userName').textContent = name;
        document.getElementById('userInitials').textContent = initials;
        
        // Update dropdown profile
        document.getElementById('dropdownUserName').textContent = name;
        document.getElementById('dropdownUserEmail').textContent = email;
        document.getElementById('dropdownUserInitials').textContent = initials;
      }

      // Toggle profile dropdown
      function toggleProfileDropdown() {
        const dropdown = document.getElementById('profileDropdown');
        const arrow = document.getElementById('dropdownArrow');
        
        if (dropdown.classList.contains('hidden')) {
          dropdown.classList.remove('hidden');
          arrow.style.transform = 'rotate(180deg)';
        } else {
          dropdown.classList.add('hidden');
          arrow.style.transform = 'rotate(0deg)';
        }
      }

      // Close dropdown when clicking outside
      document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('profileDropdown');
        const button = document.getElementById('profileDropdownBtn');
        
        if (!dropdown.contains(event.target) && !button.contains(event.target)) {
          dropdown.classList.add('hidden');
          document.getElementById('dropdownArrow').style.transform = 'rotate(0deg)';
        }
      });



      // Logout function
      async function logout() {
        try {
          await account.deleteSession('current');
          window.location.href = '/login';
        } catch (error) {
          console.error('Logout error:', error);
          window.location.href = '/login';
        }
      }

      // Load dashboard data
      async function loadDashboardData() {
        try {
          // Get user assessments from Appwrite
          const response = await databases.listDocuments(
            DATABASE_ID,
            ASSESSMENTS_COLLECTION_ID,
            [
              Appwrite.Query.equal("userId", currentUser.$id),
              Appwrite.Query.orderDesc("assessmentDate")
            ]
          );
          
          assessments = response.documents;
          
          // Hide loading, show content
          document.getElementById('loading').classList.add('hidden');
          document.getElementById('dashboard-content').classList.remove('hidden');
          
          // Update dashboard
          updateDashboardStats();
          displayAssessmentHistory();
          
        } catch (error) {
          console.error('Error loading dashboard data:', error);
          document.getElementById('loading').classList.add('hidden');
          document.getElementById('error-state').classList.remove('hidden');
        }
      }

      // Update dashboard statistics
      function updateDashboardStats() {
        const totalAssessments = assessments.length;
        document.getElementById('total-assessments').textContent = totalAssessments;
        
        if (totalAssessments > 0) {
          const latest = assessments[0];
          document.getElementById('latest-score').textContent = `${latest.finalScore}/260`;
          document.getElementById('latest-classification').textContent = latest.classification;
          
          // Calculate trend
          if (totalAssessments > 1) {
            const previous = assessments[1];
            const trend = latest.finalScore - previous.finalScore;
            const trendElement = document.getElementById('progress-trend');
            
            if (trend > 0) {
              trendElement.textContent = `+${trend}`;
              trendElement.className = 'text-green-600 text-3xl font-bold';
            } else if (trend < 0) {
              trendElement.textContent = `${trend}`;
              trendElement.className = 'text-red-600 text-3xl font-bold';
            } else {
              trendElement.textContent = '0';
              trendElement.className = 'text-[#1E5245] text-3xl font-bold';
            }
          }
        }
      }

      // Display assessment history
      function displayAssessmentHistory() {
        const listContainer = document.getElementById('assessment-list');
        const noAssessmentsDiv = document.getElementById('no-assessments');
        
        if (assessments.length === 0) {
          noAssessmentsDiv.classList.remove('hidden');
          return;
        }
        
        listContainer.innerHTML = '';
        
        assessments.forEach((assessment, index) => {
          const assessmentDate = new Date(assessment.assessmentDate);
          const formattedDate = assessmentDate.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
          
          // Get classification color
          let classificationColor = 'bg-gray-100 text-gray-800';
          if (assessment.classification === 'Good') {
            classificationColor = 'bg-green-100 text-green-800';
          } else if (assessment.classification === 'Moderate') {
            classificationColor = 'bg-yellow-100 text-yellow-800';
          } else if (assessment.classification === 'Poor') {
            classificationColor = 'bg-red-100 text-red-800';
          }
          
          const assessmentCard = document.createElement('div');
          assessmentCard.className = 'bg-white rounded-xl p-6 border border-[#e9f1e9] shadow-sm hover:shadow-md transition-shadow duration-200';
          assessmentCard.innerHTML = `
            <div class="flex justify-between items-start mb-4">
              <div>
                <h3 class="text-[#101910] text-lg font-bold">Assessment #${assessments.length - index}</h3>
                <p class="text-[#578e57] text-sm">${formattedDate}</p>
              </div>
              <span class="px-3 py-1 rounded-full text-xs font-medium ${classificationColor}">
                ${assessment.classification}
              </span>
            </div>
            
            <div class="grid grid-cols-2 gap-4 mb-4">
              <div>
                <p class="text-[#578e57] text-sm">Final Score</p>
                <p class="text-[#101910] text-xl font-bold">${assessment.finalScore}/260</p>
              </div>
              <div>
                <p class="text-[#578e57] text-sm">Percentage</p>
                <p class="text-[#101910] text-xl font-bold">${Math.round((assessment.finalScore / 260) * 100)}%</p>
              </div>
            </div>
            
            <div class="flex justify-between items-center">
              <button
                onclick="viewAssessmentDetails('${assessment.$id}')"
                class="text-[#1E5245] text-sm font-medium hover:underline"
              >
                View Details
              </button>
              <div class="w-full max-w-xs bg-[#e9f1e9] rounded-full h-2 ml-4">
                <div class="bg-[#1E5245] h-2 rounded-full" style="width: ${(assessment.finalScore / 260) * 100}%"></div>
              </div>
            </div>
          `;
          
          listContainer.appendChild(assessmentCard);
        });
      }

      // View assessment details (placeholder function)
      function viewAssessmentDetails(assessmentId) {
        // For now, just show an alert. In a full implementation, 
        // this would open a detailed view or modal
        alert(`Assessment details for ID: ${assessmentId}\n\nThis feature will show detailed breakdown of responses and recommendations.`);
      }

      // Initialize dashboard on page load
      window.onload = checkAuthentication;
    </script>
  </body>
</html> 